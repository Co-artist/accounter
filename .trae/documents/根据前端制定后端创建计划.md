# 根据前端制定后端创建计划

## 一、前端需求分析

### 1. 用户认证
- 登录功能：用户名+密码登录
- 注册功能：用户名+密码注册
- 获取当前用户信息
- 登录状态持久化（token）

### 2. 交易管理
- 添加交易：收入/支出，金额、分类、日期、备注
- 更新交易
- 删除交易
- 查询交易：按日期范围、分类、金额范围
- 获取交易列表

### 3. 分类管理
- 添加分类：名称、图标、类型（收入/支出）、颜色
- 更新分类
- 删除分类
- 查询分类列表
- 按类型筛选分类

### 4. 预算管理
- 添加预算：分类、金额、周期（周/月/年）
- 更新预算
- 删除预算
- 查询预算列表
- 按分类查询预算
- 按类型筛选预算

### 5. 统计分析
- 收支摘要：总收入、总支出、结余
- 分类占比：按分类统计金额占比
- 月度趋势：按月统计收支情况
- 年度对比：按年统计收支情况

## 二、后端技术栈

### 1. 核心框架
- **Node.js** (v20+) - JavaScript运行时
- **Express.js** (v4.x) - Web应用框架

### 2. 数据库
- **MongoDB** (v7.x) - 文档型数据库
- **Mongoose** (v8.x) - ODM框架

### 3. 身份认证
- **JWT** (JSON Web Token) - 无状态身份验证
- **bcrypt.js** - 密码加密

### 4. 开发工具
- **ESLint** - 代码质量检查
- **Prettier** - 代码格式化
- **Jest** - 单元测试
- **Supertest** - API测试

### 5. 部署
- **Docker** - 容器化部署
- **Docker Compose** - 多容器编排

## 三、数据库设计

### 1. 用户模型 (User)
```javascript
const userSchema = new mongoose.Schema({
  username: {
    type: String,
    required: true,
    unique: true,
    trim: true
  },
  password: {
    type: String,
    required: true
  },
  createdAt: {
    type: Date,
    default: Date.now
  },
  updatedAt: {
    type: Date,
    default: Date.now
  }
});
```

### 2. 交易模型 (Transaction)
```javascript
const transactionSchema = new mongoose.Schema({
  userId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  type: {
    type: String,
    required: true,
    enum: ['income', 'expense']
  },
  amount: {
    type: Number,
    required: true,
    min: 0
  },
  category: {
    type: String,
    required: true
  },
  date: {
    type: Date,
    required: true
  },
  note: {
    type: String,
    trim: true
  },
  createdAt: {
    type: Date,
    default: Date.now
  },
  updatedAt: {
    type: Date,
    default: Date.now
  }
});
```

### 3. 分类模型 (Category)
```javascript
const categorySchema = new mongoose.Schema({
  userId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  name: {
    type: String,
    required: true,
    trim: true
  },
  icon: {
    type: String,
    required: true
  },
  type: {
    type: String,
    required: true,
    enum: ['income', 'expense']
  },
  color: {
    type: String,
    required: true
  },
  usageCount: {
    type: Number,
    default: 0
  },
  amountRatio: {
    type: Number,
    default: 0
  },
  createdAt: {
    type: Date,
    default: Date.now
  },
  updatedAt: {
    type: Date,
    default: Date.now
  }
});
```

### 4. 预算模型 (Budget)
```javascript
const budgetSchema = new mongoose.Schema({
  userId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  category: {
    type: String,
    required: true
  },
  icon: {
    type: String,
    required: true
  },
  amount: {
    type: Number,
    required: true,
    min: 0
  },
  used: {
    type: Number,
    default: 0
  },
  usagePercentage: {
    type: Number,
    default: 0
  },
  period: {
    type: String,
    required: true,
    enum: ['weekly', 'monthly', 'yearly']
  },
  type: {
    type: String,
    required: true,
    enum: ['income', 'expense']
  },
  createdAt: {
    type: Date,
    default: Date.now
  },
  updatedAt: {
    type: Date,
    default: Date.now
  }
});
```

## 四、API接口设计

### 1. 认证相关

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| POST | /api/auth/register | 用户注册 | 无 |
| POST | /api/auth/login | 用户登录 | 无 |
| GET | /api/auth/me | 获取当前用户 | 需要认证 |

### 2. 交易相关

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/transactions | 获取交易列表 | 需要认证 |
| GET | /api/transactions/:id | 获取单个交易 | 需要认证 |
| POST | /api/transactions | 创建交易 | 需要认证 |
| PUT | /api/transactions/:id | 更新交易 | 需要认证 |
| DELETE | /api/transactions/:id | 删除交易 | 需要认证 |
| GET | /api/transactions/filter | 筛选交易 | 需要认证 |

### 3. 分类相关

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/categories | 获取分类列表 | 需要认证 |
| GET | /api/categories/:id | 获取单个分类 | 需要认证 |
| POST | /api/categories | 创建分类 | 需要认证 |
| PUT | /api/categories/:id | 更新分类 | 需要认证 |
| DELETE | /api/categories/:id | 删除分类 | 需要认证 |
| GET | /api/categories/type/:type | 按类型获取分类 | 需要认证 |

### 4. 预算相关

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/budgets | 获取预算列表 | 需要认证 |
| GET | /api/budgets/:id | 获取单个预算 | 需要认证 |
| POST | /api/budgets | 创建预算 | 需要认证 |
| PUT | /api/budgets/:id | 更新预算 | 需要认证 |
| DELETE | /api/budgets/:id | 删除预算 | 需要认证 |
| GET | /api/budgets/category/:category | 按分类获取预算 | 需要认证 |
| GET | /api/budgets/type/:type | 按类型获取预算 | 需要认证 |

### 5. 统计相关

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/stats/summary | 获取收支摘要 | 需要认证 |
| GET | /api/stats/category | 获取分类占比 | 需要认证 |
| GET | /api/stats/period | 获取周期统计 | 需要认证 |
| GET | /api/stats/trend | 获取趋势分析 | 需要认证 |

## 五、项目结构设计

```
backend/
├── config/              # 配置文件
│   ├── config.js        # 主配置
│   └── database.js      # 数据库配置
├── controllers/         # 控制器
│   ├── authController.js    # 认证相关
│   ├── transactionController.js  # 交易相关
│   ├── categoryController.js     # 分类相关
│   ├── budgetController.js       # 预算相关
│   └── statsController.js        # 统计相关
├── middleware/          # 中间件
│   ├── authMiddleware.js     # 认证中间件
│   ├── errorMiddleware.js    # 错误处理
│   └── corsMiddleware.js     # CORS配置
├── models/              # 数据模型
│   ├── User.js          # 用户模型
│   ├── Transaction.js   # 交易模型
│   ├── Category.js      # 分类模型
│   └── Budget.js        # 预算模型
├── routes/              # 路由
│   ├── authRoutes.js        # 认证路由
│   ├── transactionRoutes.js # 交易路由
│   ├── categoryRoutes.js    # 分类路由
│   ├── budgetRoutes.js      # 预算路由
│   └── statsRoutes.js       # 统计路由
├── services/            # 业务逻辑
│   ├── authService.js       # 认证服务
│   ├── transactionService.js   # 交易服务
│   ├── categoryService.js      # 分类服务
│   ├── budgetService.js        # 预算服务
│   └── statsService.js         # 统计服务
├── utils/               # 工具函数
│   ├── jwt.js           # JWT工具
│   ├── logger.js        # 日志工具
│   └── passwordUtils.js # 密码处理
├── tests/               # 测试文件
│   ├── auth.test.js     # 认证测试
│   ├── transaction.test.js    # 交易测试
│   ├── category.test.js       # 分类测试
│   ├── budget.test.js         # 预算测试
│   └── stats.test.js          # 统计测试
├── .env.example         # 环境变量示例
├── .gitignore           # Git忽略文件
├── package.json         # 项目依赖
├── app.js               # 应用入口
└── server.js            # 服务器启动
```

## 六、开发步骤

### 1. 环境准备
- 安装Node.js和MongoDB
- 初始化项目：`npm init -y`
- 安装依赖：`npm install express mongoose bcryptjs jsonwebtoken cors dotenv`
- 安装开发依赖：`npm install -D nodemon eslint prettier jest supertest`

### 2. 配置文件
- 创建`.env`文件，配置环境变量
- 配置数据库连接
- 配置JWT密钥
- 配置CORS

### 3. 数据模型
- 创建用户模型
- 创建交易模型
- 创建分类模型
- 创建预算模型

### 4. 中间件
- 创建认证中间件
- 创建错误处理中间件
- 创建CORS中间件

### 5. 认证相关
- 实现注册功能
- 实现登录功能
- 实现获取当前用户信息

### 6. 交易相关
- 实现获取交易列表
- 实现创建交易
- 实现更新交易
- 实现删除交易
- 实现筛选交易

### 7. 分类相关
- 实现获取分类列表
- 实现创建分类
- 实现更新分类
- 实现删除分类
- 实现按类型获取分类

### 8. 预算相关
- 实现获取预算列表
- 实现创建预算
- 实现更新预算
- 实现删除预算
- 实现按分类获取预算
- 实现按类型获取预算

### 9. 统计相关
- 实现获取收支摘要
- 实现获取分类占比
- 实现获取周期统计
- 实现获取趋势分析

### 10. 测试
- 编写单元测试
- 编写API测试
- 进行集成测试
- 测试所有功能

### 11. 部署
- 配置Dockerfile
- 编写Docker Compose配置
- 部署到服务器

## 七、技术要点

### 1. 身份认证
- 使用JWT进行无状态身份验证
- 密码使用bcrypt加密存储
- 实现token刷新机制

### 2. 数据库操作
- 使用Mongoose进行数据库操作
- 实现数据关联查询
- 优化查询性能

### 3. 错误处理
- 统一的错误处理机制
- 友好的错误信息
- 详细的错误日志

### 4. 安全考虑
- 防止SQL注入
- 防止XSS攻击
- 防止CSRF攻击
- 实现速率限制
- 安全的密码存储

### 5. 性能优化
- 实现数据缓存
- 优化数据库查询
- 实现分页查询
- 优化API响应时间

## 八、前端集成

### 1. API调用
- 使用axios进行API调用
- 实现请求拦截器，自动添加token
- 实现响应拦截器，处理401错误

### 2. 数据同步
- 实现前端数据与后端数据的同步
- 处理数据冲突
- 实现离线支持

### 3. 错误处理
- 处理各种API错误
- 显示友好的错误信息
- 实现重试机制

## 九、测试计划

### 1. 单元测试
- 测试数据模型
- 测试业务逻辑
- 测试工具函数

### 2. API测试
- 测试所有API接口
- 测试各种请求参数
- 测试错误情况

### 3. 集成测试
- 测试前后端集成
- 测试完整的业务流程
- 测试各种边界情况

### 4. 性能测试
- 测试API响应时间
- 测试数据库查询性能
- 测试并发处理能力

## 十、部署计划

### 1. 环境准备
- 准备服务器
- 安装Docker和Docker Compose
- 配置环境变量

### 2. 容器化部署
- 构建Docker镜像
- 配置Docker Compose
- 启动服务

### 3. 监控与维护
- 配置日志监控
- 配置性能监控
- 实现自动备份
- 实现自动恢复

## 十一、后续优化

### 1. 功能优化
- 添加更多的统计分析功能
- 实现数据导入/导出
- 实现数据备份/恢复
- 添加社交分享功能

### 2. 性能优化
- 实现数据分片
- 优化数据库索引
- 实现CDN加速
- 优化前端资源加载

### 3. 安全优化
- 实现多因素认证
- 添加API网关
- 实现WAF防护
- 定期进行安全审计

### 4. 用户体验优化
- 添加推送通知
- 实现智能推荐
- 添加语音输入
- 实现黑暗模式

## 十二、总结

本计划详细说明了根据前端需求制定的后端开发计划，包括技术栈选择、数据库设计、API接口设计、项目结构、开发步骤、测试计划和部署计划。通过遵循此计划，可以创建一个功能完整、性能优良、安全可靠的后端服务，满足前端的所有需求。