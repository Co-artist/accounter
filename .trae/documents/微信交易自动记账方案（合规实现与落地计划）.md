## 可行性与合规
- 系统限制：Android 对第三方 App 的数据沙箱隔离，不能直接读取微信内部账单数据。
- 合规能力：允许的做法是基于用户授权的系统通知监听（NotificationListenerService）解析交易通知；或用户主动导入（分享文本/文件）。避免使用侵入式无障碍爬取界面内容。
- 隐私要求：明确告知用途、仅本地处理、用户可随时关闭；不上传到服务器，或经用户明确同意后再上传。

## 方案选型
- 方案 A（推荐）：通知监听自动记账
  - 原理：用户开启“通知读取”权限后，解析微信（`com.tencent.mm`）的“支付成功/收款到账”等通知文本，实时生成交易记录。
  - 优点：自动、即时、无需用户手动导出；合规（系统权限）。
  - 局限：通知文案可能版本差异；未产生通知的交易无法捕获。
- 方案 B（补充）：手动/半自动导入
  - 从通知历史批量导入（Android 允许读取到达后的通知存档，受机型限制）。
  - 从“分享/复制”文本导入（用户在微信账单页复制一段文本到本 App 进行解析）。
  - 从银行短信解析导入（绑定银行卡消费的短信，以规则解析为交易）。

## 技术实现
- 新增原生插件（Capacitor 插件）：`WechatBillListener`
  - 能力：
    - `requestPermission()` 请求并引导用户到“通知使用权”设置页。
    - `startListening()`/`stopListening()` 开启/关闭监听服务。
    - `getRecent(n)` 获取最近若干解析后的交易事件（用于首启批量导入）。
    - 事件流：`onNotification(event)` 通过 JS 事件把解析结果推送到前端。
  - 过滤：仅处理包名 `com.tencent.mm` 的通知；可扩展支付宝/银行等。
  - 解析：
    - 设计多套正则/规则适配常见文案，如“支付成功¥12.50，商户：XXX”，“微信支付收款到账¥88.00”等。
    - 提取字段：`amount`、`type(income/expense)`、`merchant`/`peer`、`time`、`channel=wechat`、`originalText`。
    - 中英/繁体/不同机型差异通过可更新的“规则表”（本地 JSON + OTA 配置）管理。
- 前端集成
  - 设置页新增“自动记账（微信）”开关与权限状态指示；首次开启时引导授权。
  - 交易列表新增“来源：微信”标记与筛选；首次开启提供“导入最近通知”按钮。
  - 冲突与去重：以 `hash(channel+amount+time+merchant)` 做去重；短时间内重复通知合并。
  - 回退与修正：解析失败进入“待确认”，用户手动补全类别与备注。
- 数据存储
  - 本地数据库（沿用现有 `store`/IndexedDB）：新增 `sourceMeta` 字段保存原始通知片段，方便审计与复查。
  - 不默认上传；如需云同步，先征得用户同意并脱敏。

## 手动/半自动导入
- 通知历史批量：`getRecent(n)` 拉取最近一段时间通知，批量解析后展示预览，用户一键确认导入。
- 分享/复制文本：在记账页提供“从剪贴板导入”与“分享进来解析”入口，解析格式化文本或半结构化段落。
- 银行短信：可选开启“短信读取”权限，解析与微信相同字段入账；仅本地处理。

## 安全与隐私
- 权限弹窗与说明页写明用途、范围、关闭方式。
- 仅在本地解析与存储；默认不上传；提供一键清除来源数据。
- 正则规则通过 OTA 更新（你的现有 OTA链路）以适配文案变化，但不包含任何用户数据。

## 发布与测试
- 测试用例：构造多种通知文案进行单元测试与集成测试；中英文/金额格式/商户名边界。
- 真机验证：不同品牌与系统版本的通知内容差异；开启/关闭权限的状态切换；后台运行稳定性。
- 失败回退：监听失败时 UI 保持可用，提示用户手动导入或检查权限。

## 最终交付
- 原生插件（Android）：`WechatBillListener` 源码与接口文档。
- 前端集成：设置项、导入入口、交易标记、去重与修正流。
- 规则维护：本地规则 JSON + OTA 更新机制；文案适配指南。

## 里程（不含时间表）
- 插件骨架与权限引导 → 解析器与规则 → 前端设置与导入 UI → 去重与修正 → 测试与真机验证 → 上线与迭代。

请确认采用“通知监听+手动导入”的组合方案；确认后我将按以上计划开始实现 Android 插件与前端集成。